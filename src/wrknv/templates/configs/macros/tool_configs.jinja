{#
Jinja2 macros for tool configurations in pyproject.toml templates
#}

{%- macro ruff_config(
    line_length=111,
    target_version="py311",
    select=["E", "F", "W", "I", "UP", "ANN", "B", "C90", "SIM", "PTH", "RUF"],
    ignore=["ANN401", "B008", "E501"],
    known_first_party=None,
    exclude=None
) -%}
[tool.ruff]
line-length = {{ line_length }}
indent-width = 4
target-version = "{{ target_version }}"
{%- if exclude %}
exclude = {{ format_dependency_list(exclude) }}
{%- endif %}

[tool.ruff.lint]
select = {{ format_dependency_list(select) }}
ignore = {{ format_dependency_list(ignore) }}

[tool.ruff.lint.isort]
{%- if known_first_party %}
known-first-party = {{ format_dependency_list(known_first_party) }}
{%- else %}
known-first-party = ["{{ project_name.replace('-', '_') }}"]
{%- endif %}
force-sort-within-sections = true
combine-as-imports = true

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"
{%- endmacro -%}

{%- macro mypy_config(
    python_version="3.11",
    strict=true,
    mypy_path="src",
    exclude=None,
    overrides=None
) -%}
[tool.mypy]
python_version = "{{ python_version }}"
mypy_path = "{{ mypy_path }}"
strict = {{ strict | lower }}
pretty = true
show_error_codes = true
show_column_numbers = true
warn_unused_ignores = true
warn_unused_configs = true
disallow_untyped_decorators = false
{%- if exclude %}
exclude = {{ format_dependency_list(exclude) }}
{%- endif %}

{%- if overrides %}
{%- for override in overrides %}
[[tool.mypy.overrides]]
module = {{ format_dependency_list(override.modules) }}
{%- for key, value in override.settings.items() %}
{{ key }} = {{ value | lower if value is boolean else value }}
{%- endfor %}
{%- endfor -%}
{%- endif -%}
{%- endmacro -%}

{%- macro pytest_config(
    log_level="DEBUG",
    testpaths=["tests"],
    markers=None,
    asyncio_mode="auto"
) -%}
[tool.pytest.ini_options]
minversion = "7.0"
log_cli = true
log_cli_level = "{{ log_level }}"
asyncio_mode = "{{ asyncio_mode }}"
testpaths = {{ format_dependency_list(testpaths) }}
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*", "*Tests"]
python_functions = ["test_*", "*_test"]
addopts = [
    "-ra",
    "-q",
    "--strict-markers",
    "--color=yes",
    "--tb=short",
]
{%- if markers %}
markers = [
{%- for marker in markers %}
    "{{ marker }}",
{%- endfor %}
]
{%- else %}
markers = [
    "unit: Fast unit tests",
    "integration: Integration tests requiring setup",
    "slow: Slow running tests (>1s)",
    "fast: Fast tests (<100ms)",
]
{%- endif %}
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
    "ignore::pytest.PytestUnraisableExceptionWarning",
]
{%- endmacro -%}

{%- macro coverage_config(
    source=None,
    omit=None,
    fail_under=80
) -%}
[tool.coverage.run]
{%- if source %}
source = {{ format_dependency_list(source) }}
{%- else %}
source = ["{{ project_name.replace('-', '_') }}"]
{%- endif %}
branch = true
parallel = true
{%- if omit %}
omit = {{ format_dependency_list(omit) }}
{%- endif %}

[tool.coverage.report]
show_missing = true
skip_covered = true
fail_under = {{ fail_under }}
precision = 2
exclude_lines = [
    "pragma: no cover",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "def __repr__",
    "def __str__",
    "@(abc\\.)?abstractmethod",
    "pass",
]
{%- endmacro -%}

{%- macro bandit_config(exclude_dirs=None) -%}
[tool.bandit]
{%- if exclude_dirs %}
exclude_dirs = {{ format_dependency_list(exclude_dirs) }}
{%- else %}
exclude_dirs = [".venv", "*/tests", "workenv"]
{%- endif %}
{%- endmacro -%}

{%- macro setuptools_config(
    package_dir="src",
    dynamic_version=true,
    include_package_data=true
) -%}
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[tool.setuptools]
{%- if include_package_data %}
include-package-data = true
{%- endif %}
package-dir = {"" = "{{ package_dir }}"}

[tool.setuptools.packages.find]
where = ["{{ package_dir }}"]
include = ["{{ project_name.replace('-', '_') }}*"]
namespaces = false

{%- if dynamic_version %}
[tool.setuptools.dynamic]
version = {file = "VERSION"}
{%- endif -%}
{%- endmacro -%}