#
# SPDX-FileCopyrightText: Copyright (c) provide.io llc. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#

"""Tests for Gitignore Builder
============================"""

from __future__ import annotations

from provide.testkit.mocking import patch
import pytest

from wrknv.gitignore.builder import GitignoreBuilder


class TestGitignoreBuilder:
    """Test suite for GitignoreBuilder."""

    @pytest.fixture
    def builder(self):
        """Create a GitignoreBuilder instance."""
        return GitignoreBuilder()

    def test_init(self, builder) -> None:
        """Test builder initialization."""
        assert builder.sections == []
        assert builder.custom_rules == []

    def test_add_header_without_project(self, builder) -> None:
        """Test adding header without project name."""
        with patch("wrknv.gitignore.builder.provide_now") as mock_now:
            mock_now.return_value.strftime.return_value = "2024-01-01 12:00:00"
            builder.add_header()

        assert len(builder.sections) == 1
        section_name, content = builder.sections[0]
        assert section_name == "header"
        assert "Generated by wrknv" in content
        assert "Date: 2024-01-01 12:00:00" in content
        assert "Project:" not in content

    def test_add_header_with_project(self, builder) -> None:
        """Test adding header with project name."""
        with patch("wrknv.gitignore.builder.provide_now") as mock_now:
            mock_now.return_value.strftime.return_value = "2024-01-01 12:00:00"
            builder.add_header(project_name="test-project")

        assert len(builder.sections) == 1
        section_name, content = builder.sections[0]
        assert section_name == "header"
        assert "Project: test-project" in content

    def test_add_template_section(self, builder) -> None:
        """Test adding a template section."""
        builder.add_template_section("Python", "*.pyc\n__pycache__/")

        assert len(builder.sections) == 1
        section_name, content = builder.sections[0]
        assert section_name == "Python"
        assert "=== Python ===" in content
        assert "*.pyc" in content
        assert "__pycache__/" in content

    def test_add_template_section_empty_content(self, builder) -> None:
        """Test adding template section with empty content."""
        builder.add_template_section("Empty", "")
        assert len(builder.sections) == 0

    def test_add_wrknv_section(self, builder) -> None:
        """Test adding wrknv-specific section."""
        builder.add_wrknv_section()

        assert len(builder.sections) == 1
        section_name, content = builder.sections[0]
        assert section_name == "wrknv"
        assert "=== wrknv ===" in content
        assert "workenv/" in content
        assert "wrknv_*/" in content
        assert ".wrknv/" in content

    def test_add_custom_rules(self, builder) -> None:
        """Test adding custom rules."""
        rules = ["*.secret", "local-config.toml", "# My custom comment"]
        builder.add_custom_rules(rules)

        assert builder.custom_rules == rules

    def test_add_custom_rules_empty(self, builder) -> None:
        """Test adding empty custom rules."""
        builder.add_custom_rules([])
        assert builder.custom_rules == []

    def test_build_simple(self, builder) -> None:
        """Test building a simple gitignore."""
        builder.add_template_section("Python", "*.pyc\n__pycache__/")
        builder.add_template_section("Node", "node_modules/")

        result = builder.build()

        assert "=== Python ===" in result
        assert "*.pyc" in result
        assert "=== Node ===" in result
        assert "node_modules/" in result
        assert result.endswith("\n")

    def test_build_with_duplicates(self, builder) -> None:
        """Test building with duplicate patterns removed."""
        builder.add_template_section("Template1", "*.pyc\n.env")
        builder.add_template_section("Template2", "*.pyc\n.secret")  # *.pyc is duplicate

        result = builder.build(merge_duplicates=True)

        # *.pyc should appear only once
        assert result.count("*.pyc") == 1
        assert ".env" in result
        assert ".secret" in result

    def test_build_without_merge_duplicates(self, builder) -> None:
        """Test building without removing duplicates."""
        builder.add_template_section("Template1", "*.pyc\n.env")
        builder.add_template_section("Template2", "*.pyc\n.secret")

        result = builder.build(merge_duplicates=False)

        # *.pyc should appear twice
        assert result.count("*.pyc") == 2

    def test_build_with_custom_rules(self, builder) -> None:
        """Test building with custom rules."""
        builder.add_template_section("Python", "*.pyc")
        builder.add_custom_rules(["*.secret", "# My custom pattern", "local.conf"])

        result = builder.build()

        assert "=== Custom Rules ===" in result
        assert "*.secret" in result
        assert "# My custom pattern" in result
        assert "local.conf" in result

    def test_build_custom_rules_deduplication(self, builder) -> None:
        """Test that custom rules are deduplicated against template patterns."""
        builder.add_template_section("Python", "*.pyc\n.env")
        builder.add_custom_rules(["*.pyc", ".secret"])  # *.pyc is duplicate

        result = builder.build(merge_duplicates=True)

        # *.pyc should appear only once (in template section)
        assert result.count("*.pyc") == 1
        assert ".secret" in result

    def test_build_preserves_comments(self, builder) -> None:
        """Test that comments are preserved and not deduplicated."""
        builder.add_template_section("Template1", "# Python files\n*.pyc")
        builder.add_template_section("Template2", "# Python files\n*.pyo")

        result = builder.build(merge_duplicates=True)

        # Comments should be preserved even if identical
        assert result.count("# Python files") == 2

    def test_build_complete_gitignore(self, builder) -> None:
        """Test building a complete gitignore with all sections."""
        with patch("wrknv.gitignore.builder.provide_now") as mock_now:
            mock_now.return_value.strftime.return_value = "2024-01-01 12:00:00"
            builder.add_header(project_name="test-project")

        builder.add_template_section("Python", "*.pyc\n__pycache__/")
        builder.add_template_section("Node", "node_modules/")
        builder.add_wrknv_section()
        builder.add_custom_rules(["*.secret", "local.conf"])

        result = builder.build()

        # Check all sections are present and in order
        assert "Generated by wrknv" in result
        assert result.index("Generated by wrknv") < result.index("=== Python ===")
        assert result.index("=== Python ===") < result.index("=== Node ===")
        assert result.index("=== Node ===") < result.index("=== wrknv ===")
        assert result.index("=== wrknv ===") < result.index("=== Custom Rules ===")

    def test_merge_with_existing_no_file(self, builder, tmp_path) -> None:
        """Test merging when no existing file exists."""
        builder.add_template_section("Python", "*.pyc")

        non_existent = tmp_path / "non_existent.gitignore"
        result = builder.merge_with_existing(non_existent)

        assert "*.pyc" in result

    def test_merge_with_existing_preserves_custom_rules(self, builder, tmp_path) -> None:
        """Test merging preserves custom rules from existing file."""
        # Create existing gitignore with custom section
        existing_file = tmp_path / ".gitignore"
        existing_content = """
# Generated content
*.pyc

# === Custom Rules ===
# My custom patterns
*.secret
local.conf
private/

# === End ===
"""
        existing_file.write_text(existing_content)

        builder.add_template_section("Python", "*.pyc\n.venv/")
        result = builder.merge_with_existing(existing_file)

        assert "*.secret" in result
        assert "local.conf" in result
        assert "private/" in result
        assert ".venv/" in result

    def test_merge_with_existing_various_custom_markers(self, builder, tmp_path) -> None:
        """Test merging recognizes various custom section markers."""
        existing_file = tmp_path / ".gitignore"
        existing_content = """
*.pyc

# Custom project rules
*.secret
debug.log
"""
        existing_file.write_text(existing_content)

        builder.add_template_section("Python", "*.pyc")
        result = builder.merge_with_existing(existing_file)

        assert "*.secret" in result
        assert "debug.log" in result

    def test_sections_are_separated_by_double_newlines(self, builder) -> None:
        """Test that sections are separated by double newlines."""
        builder.add_template_section("Python", "*.pyc")
        builder.add_template_section("Node", "node_modules/")

        result = builder.build()

        # Check for double newline between sections
        assert "\n\n" in result

    def test_empty_lines_preserved_in_templates(self, builder) -> None:
        """Test that empty lines within templates are preserved."""
        template_content = """*.pyc
__pycache__/

# Virtual environments
.venv/
env/"""

        builder.add_template_section("Python", template_content)
        result = builder.build()

        # The empty line between __pycache__/ and # Virtual environments should be preserved
        assert "__pycache__/\n\n# Virtual environments" in result


# ğŸ§°ğŸŒğŸ”š
